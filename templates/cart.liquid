<!-- CART TEMPLATE - Carrello Lucine di Natale -->
<div class="page-container" style="min-height: 100vh; padding: 2rem 1rem;">
  <div class="content-wrapper" style="max-width: 1200px; margin: 0 auto;">
    <div class="formatted-content" style="background: rgba(15, 47, 31, 0.4); border-radius: 16px; padding: 2rem; border: 1px solid rgba(255,255,255,0.1);">
      
      <!-- CART HEADER -->
      <section class="cart-header">
        <h1 style="color: var(--christmas-red); text-align: center;">üõí Il Tuo Carrello</h1>
        {% if cart.item_count > 0 %}
          <p style="text-align: center; color: rgba(255,255,255,0.9);">
            Hai <strong>{{ cart.item_count }}</strong> {% if cart.item_count == 1 %}biglietto{% else %}biglietti{% endif %} nel carrello
          </p>
        {% endif %}
      </section>

      {% if cart.item_count > 0 %}
        <!-- CART ITEMS -->
        <section class="cart-items" style="margin: 2rem 0;">
          <form action="/cart" method="post" id="cart-form">
            
            {% for item in cart.items %}
            <div class="cart-item" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; display: flex; gap: 1.5rem; align-items: center;">
              
              <!-- Item Image -->
              {% if item.image %}
              <div class="item-image" style="flex-shrink: 0;">
                <img src="{{ item.image | img_url: '150x150' }}" alt="{{ item.title }}" style="width: 100px; height: 100px; border-radius: 8px; object-fit: cover;">
              </div>
              {% endif %}
              
              <!-- Item Info -->
              <div class="item-info" style="flex: 1;">
                <h3 style="color: var(--christmas-green); margin: 0 0 0.5rem 0;">{{ item.product.title }}</h3>
                {% if item.variant.title != 'Default Title' %}
                  <p style="margin: 0 0 0.5rem 0; color: rgba(255,255,255,0.8);">
                    <strong>Tipo:</strong> {{ item.variant.title }}
                  </p>
                {% endif %}
                {% for property in item.properties %}
                  {% unless property.first contains '_' %}
                    <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                      <strong>{{ property.first }}:</strong> {{ property.last }}
                    </p>
                  {% endunless %}
                {% endfor %}
              </div>
              
              <!-- Quantity Controls -->
              <div class="item-quantity" style="display: flex; align-items: center; gap: 0.5rem;">
                <button type="button" class="qty-btn" onclick="updateQuantity('{{ item.key }}', {{ item.quantity }} - 1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚àí</button>
                <input type="number" 
                       name="updates[{{ item.key }}]" 
                       value="{{ item.quantity }}" 
                       min="0" 
                       class="qty-input"
                       style="width: 50px; text-align: center; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 6px;">
                <button type="button" class="qty-btn" onclick="updateQuantity('{{ item.key }}', {{ item.quantity }} + 1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">+</button>
              </div>
              
              <!-- Item Price -->
              <div class="item-price" style="text-align: right; min-width: 100px;">
                <p style="margin: 0; color: var(--christmas-red); font-size: 1.2rem; font-weight: 700;">
                  {{ item.final_line_price | money }}
                </p>
                {% if item.original_line_price != item.final_line_price %}
                  <p style="margin: 0; color: rgba(255,255,255,0.5); text-decoration: line-through; font-size: 0.9rem;">
                    {{ item.original_line_price | money }}
                  </p>
                {% endif %}
              </div>
              
              <!-- Remove Button -->
              <div class="item-remove">
                <button type="button" 
                        onclick="updateQuantity('{{ item.key }}', 0)" 
                        style="background: transparent; border: 1px solid rgba(220, 38, 38, 0.5); color: var(--christmas-red); padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.3s;"
                        onmouseover="this.style.background='rgba(220, 38, 38, 0.1)'"
                        onmouseout="this.style.background='transparent'">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            {% endfor %}
            
            <!-- Update Cart Button (hidden, triggered by JS) -->
            <button type="submit" name="update" id="update-cart-btn" style="display: none;">Aggiorna</button>
          </form>
        </section>

        <!-- CART SUMMARY -->
        <section class="cart-summary">
          <div class="sketch-card sketch seed-1">
            <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
              <defs>
                <filter id="wobble-summary">
                  <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" seed="7"/>
                  <feDisplacementMap in="SourceGraphic" scale="1"/>
                </filter>
              </defs>
              <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="14 8 6 12 10 9" vector-effect="non-scaling-stroke" filter="url(#wobble-summary)"/>
            </svg>
            
            <div class="summary-content" style="display: flex; flex-direction: column; gap: 1rem;">
              <!-- Subtotal -->
              <div style="display: flex; justify-content: space-between; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: rgba(255,255,255,0.9); font-size: 1.1rem;">Subtotale</span>
                <span style="color: white; font-size: 1.1rem; font-weight: 600;">{{ cart.total_price | money }}</span>
              </div>
              
              <!-- Discount Code -->
              <div style="padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <label style="color: var(--christmas-green); font-weight: 600; display: block; margin-bottom: 0.5rem;">üéÅ Codice Sconto</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input type="text" 
                         id="discount-code" 
                         name="discount" 
                         placeholder="Inserisci codice..."
                         style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px;">
                  <button type="button" 
                          onclick="applyDiscount()"
                          style="background: var(--christmas-green); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;"
                          onmouseover="this.style.opacity='0.9'"
                          onmouseout="this.style.opacity='1'">
                    Applica
                  </button>
                </div>
                {% if cart.cart_level_discount_applications.size > 0 %}
                <div style="margin-top: 0.5rem;">
                  {% for discount in cart.cart_level_discount_applications %}
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(139, 195, 74, 0.1); padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem;">
                      <span style="color: var(--christmas-green); font-size: 0.9rem;">
                        ‚úÖ {{ discount.title }}
                      </span>
                      <span style="color: var(--christmas-green); font-weight: 600;">
                        -{{ discount.total_allocated_amount | money }}
                      </span>
                    </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              
              <!-- Shipping Calculator -->
              <div style="padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <label style="color: var(--christmas-green); font-weight: 600; display: block; margin-bottom: 0.5rem;">üìç Calcola Spedizione</label>
                <select id="shipping-country" 
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;">
                  <option value="">Seleziona paese...</option>
                  <option value="IT">Italia</option>
                  <option value="CH">Svizzera</option>
                  <option value="FR">Francia</option>
                  <option value="DE">Germania</option>
                  <option value="AT">Austria</option>
                </select>
                <input type="text" 
                       id="shipping-zip" 
                       placeholder="CAP / Codice postale"
                       style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px;">
                <button type="button" 
                        onclick="calculateShipping()"
                        style="width: 100%; margin-top: 0.5rem; background: transparent; color: var(--christmas-green); border: 1px solid var(--christmas-green); padding: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;"
                        onmouseover="this.style.background='rgba(139, 195, 74, 0.1)'"
                        onmouseout="this.style.background='transparent'">
                  Calcola Spedizione
                </button>
              </div>
              
              <!-- Gift Options -->
              <div style="padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <label style="color: var(--christmas-green); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" 
                         id="gift-wrap" 
                         name="attributes[gift-wrap]"
                         onchange="toggleGiftOptions()"
                         style="width: 20px; height: 20px; cursor: pointer;">
                  üéÅ √à un regalo?
                </label>
                <div id="gift-options" style="display: none; margin-top: 0.75rem;">
                  <textarea name="attributes[gift-message]" 
                            placeholder="Messaggio regalo (opzionale)..."
                            style="width: 100%; min-height: 60px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; resize: vertical;"></textarea>
                  <p style="color: var(--christmas-gold); font-size: 0.9rem; margin-top: 0.5rem;">
                    ‚ú® Confezione regalo gratuita
                  </p>
                </div>
              </div>
              
              <!-- Note -->
              <div>
                <label for="cart-note" style="color: var(--christmas-green); font-weight: 600; display: block; margin-bottom: 0.5rem;">Note per l'ordine (opzionale)</label>
                <textarea name="note" 
                          id="cart-note" 
                          form="cart-form"
                          placeholder="Aggiungi eventuali note..."
                          style="width: 100%; min-height: 80px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; resize: vertical;">{{ cart.note }}</textarea>
              </div>
              
              <!-- Total -->
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid var(--christmas-gold);">
                <span style="color: var(--christmas-gold); font-size: 1.3rem; font-weight: 700;">TOTALE</span>
                <span style="color: var(--christmas-red); font-size: 1.5rem; font-weight: 700;">{{ cart.total_price | money }}</span>
              </div>
              
              <!-- Checkout Button -->
              <button type="submit" 
                      name="checkout" 
                      form="cart-form"
                      class="checkout-btn"
                      style="background: var(--christmas-red); color: white; border: none; padding: 1.2rem 2rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 1rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(220, 38, 38, 0.4)'"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.3)'">
                üéüÔ∏è Procedi al Checkout
              </button>
              
              <!-- Continue Shopping -->
              <a href="/collections/all" 
                 style="text-align: center; color: var(--christmas-green); text-decoration: underline; display: block; margin-top: 0.5rem;">
                ‚Üê Continua lo shopping
              </a>
            </div>
          </div>
        </section>

      {% else %}
        <!-- EMPTY CART -->
        <section class="empty-cart" style="text-align: center; padding: 4rem 1rem;">
          <div class="sketch-quote-card">
            <svg class="quote-sketch-background" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
              <defs>
                <filter id="wobble-empty">
                  <feTurbulence type="fractalNoise" baseFrequency="0.3" numOctaves="1" seed="10"/>
                  <feDisplacementMap in="SourceGraphic" scale="0.8"/>
                </filter>
              </defs>
              <path d="M8,8 Q25,5 50,8 Q75,5 92,8 Q95,25 92,50 Q95,75 92,92 Q75,95 50,92 Q25,95 8,92 Q5,75 8,50 Q5,25 8,8 Z" 
                    fill="rgba(255,255,255,0.04)" 
                    stroke="var(--christmas-gold)" 
                    stroke-width="1" 
                    stroke-linecap="round" 
                    stroke-dasharray="2 1" 
                    filter="url(#wobble-empty)"/>
            </svg>
            <div class="quote-content">
              <p class="quote-text" style="font-size: 1.5rem; margin-bottom: 2rem;">üõí Il tuo carrello √® vuoto</p>
              <p style="color: rgba(255,255,255,0.8); margin-bottom: 2rem;">Non hai ancora aggiunto biglietti al carrello</p>
              <a href="/products/biglietto-parco-lucine-di-natale-2025" 
                 class="cta" 
                 style="background: var(--christmas-green); color: white; padding: 1rem 2rem; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
                üéüÔ∏è Acquista Biglietti
              </a>
            </div>
          </div>
        </section>
      {% endif %}

    </div>
  </div>
</div>

<style>
/* Mobile Responsive */
@media (max-width: 768px) {
  .cart-item {
    flex-direction: column;
    text-align: center;
  }
  
  .item-image img {
    width: 150px !important;
    height: 150px !important;
  }
  
  .item-quantity {
    justify-content: center;
    margin: 1rem 0;
  }
  
  .item-price {
    text-align: center !important;
  }
  
  .cart-summary {
    position: sticky;
    bottom: 1rem;
    background: rgba(15, 47, 31, 0.95);
    padding: 1rem;
    border-radius: 12px;
    margin-top: 2rem;
  }
}
</style>

<script>
function updateQuantity(key, newQty) {
  // Trova l'input corretto e aggiorna il valore
  const input = document.querySelector(`input[name="updates[${key}]"]`);
  if (input) {
    input.value = Math.max(0, newQty);
    // Invia automaticamente il form
    document.getElementById('update-cart-btn').click();
  }
}

// Apply discount code
function applyDiscount() {
  const discountCode = document.getElementById('discount-code').value;
  if (discountCode) {
    // Shopify discount code application via fetch
    fetch('/discount/' + encodeURIComponent(discountCode) + '?redirect=/cart')
      .then(() => {
        window.location.href = '/cart';
      })
      .catch(err => {
        alert('Errore nell\'applicazione del codice sconto');
      });
  }
}

// Calculate shipping (placeholder - needs Shopify Shipping API)
function calculateShipping() {
  const country = document.getElementById('shipping-country').value;
  const zip = document.getElementById('shipping-zip').value;
  
  if (country && zip) {
    // Placeholder: mostra messaggio
    alert('Per i biglietti digitali non sono previste spese di spedizione!');
  } else {
    alert('Inserisci paese e CAP per calcolare la spedizione');
  }
}

// Toggle gift options
function toggleGiftOptions() {
  const giftWrap = document.getElementById('gift-wrap').checked;
  const giftOptions = document.getElementById('gift-options');
  
  if (giftWrap) {
    giftOptions.style.display = 'block';
  } else {
    giftOptions.style.display = 'none';
  }
}

// Auto-update cart when quantity input changes
document.addEventListener('DOMContentLoaded', function() {
  const qtyInputs = document.querySelectorAll('.qty-input');
  qtyInputs.forEach(input => {
    input.addEventListener('change', function() {
      document.getElementById('update-cart-btn').click();
    });
  });
  
  // Save note when it changes
  const noteField = document.getElementById('cart-note');
  if (noteField) {
    noteField.addEventListener('change', function() {
      document.getElementById('update-cart-btn').click();
    });
  }
  
  // Handle Enter key on discount code
  const discountInput = document.getElementById('discount-code');
  if (discountInput) {
    discountInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyDiscount();
      }
    });
  }
});
</script>