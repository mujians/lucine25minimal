<!-- CART TEMPLATE - Carrello Lucine di Natale -->

<h2 style="color: #dc2626;">CARRELLO</h2>

<h1 style="color: var(--christmas-red); text-align: center;">üõí Il Tuo Carrello</h1>
{% if cart.item_count > 0 %}
  <p style="text-align: center; color: rgba(255,255,255,0.9); font-size: 1.125rem;">
    Hai <strong>{{ cart.item_count }}</strong> {% if cart.item_count == 1 %}biglietto{% else %}biglietti{% endif %} nel carrello
  </p>
{% endif %}

{% if cart.item_count > 0 %}
  <!-- CART ITEMS -->
  <section style="margin: 2rem 0;">
    <form action="/cart" method="post" id="cart-form" style="display: contents;">
      {% for item in cart.items %}
      <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; display: flex; gap: 1.5rem; align-items: center;">
        <!-- Item Info -->
        <div style="flex: 1;">
          <h4 style="color: white; margin: 0 0 0.5rem 0;">{{ item.product.title }}</h4>
          {% if item.variant.title != 'Default Title' %}
            <p style="margin: 0 0 0.5rem 0; color: rgba(255,255,255,0.8); font-size: 1.125rem;">
              <strong>Tipo:</strong> {{ item.variant.title }}
            </p>
          {% endif %}
          {% for property in item.properties %}
            {% unless property.first contains '_' %}
              <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 1.125rem;">
                <strong>{{ property.first }}:</strong> {{ property.last }}
              </p>
            {% endunless %}
          {% endfor %}
        </div>
        
        <!-- Quantity Controls -->
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <button type="button" onclick="updateQuantity('{{ item.key }}', {{ item.quantity }} - 1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚àí</button>
          <input type="number" 
                 name="updates[{{ item.key }}]" 
                 value="{{ item.quantity }}" 
                 min="0" 
                 class="qty-input"
                 style="width: 50px; text-align: center; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 6px;">
          <button type="button" onclick="updateQuantity('{{ item.key }}', {{ item.quantity }} + 1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">+</button>
        </div>
        
        <!-- Item Price -->
        <div style="text-align: right; min-width: 100px;">
          <p style="margin: 0; color: var(--christmas-red); font-size: 1.2rem; font-weight: 700;">
            {{ item.final_line_price | money }}
          </p>
        </div>
        
        <!-- Remove Button -->
        <div>
          <button type="button" 
                  onclick="updateQuantity('{{ item.key }}', 0)" 
                  style="background: transparent; border: 1px solid rgba(220, 38, 38, 0.5); color: var(--christmas-red); padding: 0.5rem; border-radius: 6px; cursor: pointer;">
            üóëÔ∏è
          </button>
        </div>
      </div>
      {% endfor %}
      
      <!-- Update Cart Button (hidden, triggered by JS) -->
      <button type="submit" name="update" id="update-cart-btn" style="display: none;">Aggiorna</button>
    </form>
  </section>

  <!-- CART SUMMARY -->
  <section>
    <div class="sketch-card sketch seed-1">
      <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
        <defs>
          <filter id="wobble-summary">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" seed="7"/>
            <feDisplacementMap in="SourceGraphic" scale="1"/>
          </filter>
        </defs>
        <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="14 8 6 12 10 9" vector-effect="non-scaling-stroke" filter="url(#wobble-summary)"/>
      </svg>
      
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- Subtotal -->
        <div style="display: flex; justify-content: space-between; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
          <span style="color: rgba(255,255,255,0.9); font-size: 1.125rem;">Subtotale</span>
          <span style="color: white; font-size: 1.125rem; font-weight: 600;">{{ cart.total_price | money }}</span>
        </div>
        
        <!-- Discount Code -->
        <div style="padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--christmas-green); font-weight: 600; display: block; margin-bottom: 0.5rem;">üéÅ Codice Sconto</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" 
                   id="discount-code" 
                   name="discount" 
                   placeholder="Inserisci codice..."
                   style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; font-size: 1.125rem;">
            <button type="button" 
                    onclick="applyDiscount()"
                    style="background: var(--christmas-green); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.125rem; font-family: 'Providence Sans', sans-serif !important;">
              APPLICA
            </button>
          </div>
          {% if cart.cart_level_discount_applications.size > 0 %}
          <div style="margin-top: 0.5rem;">
            {% for discount in cart.cart_level_discount_applications %}
              <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(139, 195, 74, 0.1); padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem;">
                <span style="color: var(--christmas-green); font-size: 0.9rem;">
                  {{ discount.title }}
                </span>
                <span style="color: var(--christmas-green); font-weight: 600;">
                  -{{ discount.total_allocated_amount | money }}
                </span>
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
        <!-- Total -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid var(--christmas-gold);">
          <span style="color: var(--christmas-gold); font-size: 1.3rem; font-weight: 700;">TOTALE</span>
          <span style="color: var(--christmas-red); font-size: 1.5rem; font-weight: 700;">{{ cart.total_price | money }}</span>
        </div>
        
        <!-- Checkout Button -->
        <button type="submit" 
                name="checkout" 
                form="cart-form"
                style="background: var(--christmas-red); color: white; border: none; padding: 1.2rem 2rem; border-radius: 12px; font-size: 1.125rem; font-weight: 600; cursor: pointer; margin-top: 1rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); font-family: 'Providence Sans', sans-serif !important;">
          PROCEDI AL CHECKOUT
        </button>
        
        <!-- Continue Shopping -->
        <a href="/collections/all" 
           style="text-align: center; color: var(--christmas-green); text-decoration: underline; display: block; margin-top: 0.5rem; font-size: 1.125rem;">
          ‚Üê Torna ai Biglietti
        </a>
      </div>
    </div>
  </section>

{% else %}
  <!-- EMPTY CART -->
  <section style="text-align: center; padding: 4rem 1rem;">
    <div style="background: rgba(255,255,255,0.04); border-radius: 12px; padding: 3rem 2rem; border: 1px dashed var(--christmas-gold);">
      <p style="font-size: 1.5rem; margin-bottom: 2rem; color: white;">Il tuo carrello √® vuoto</p>
      <p style="color: rgba(255,255,255,0.8); margin-bottom: 2rem;">Non hai ancora aggiunto biglietti al carrello</p>
      <a href="/products/biglietto-parco-lucine-di-natale-2025" 
         style="background: var(--christmas-green); color: white; padding: 1rem 2rem; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
        Acquista Biglietti
      </a>
    </div>
  </section>
{% endif %}

<style>
/* Mobile Responsive */
@media (max-width: 768px) {
  .cart-item {
    flex-direction: column;
    text-align: center;
  }
  
  .item-image img {
    width: 150px !important;
    height: 150px !important;
  }
  
  .item-quantity {
    justify-content: center;
    margin: 1rem 0;
  }
  
  .item-price {
    text-align: center !important;
  }
  
  .cart-summary {
    position: sticky;
    bottom: 1rem;
    background: rgba(15, 47, 31, 0.95);
    padding: 1rem;
    border-radius: 12px;
    margin-top: 2rem;
  }
}
</style>

<script>
function updateQuantity(key, newQty) {
  // Trova l'input corretto e aggiorna il valore
  const input = document.querySelector(`input[name="updates[${key}]"]`);
  if (input) {
    input.value = Math.max(0, newQty);
    // Invia automaticamente il form
    document.getElementById('update-cart-btn').click();
  }
}

// Apply discount code
function applyDiscount() {
  const discountCode = document.getElementById('discount-code').value;
  if (discountCode) {
    // Shopify discount code application via fetch
    fetch('/discount/' + encodeURIComponent(discountCode) + '?redirect=/cart')
      .then(() => {
        window.location.href = '/cart';
      })
      .catch(err => {
        alert('Errore nell\'applicazione del codice sconto');
      });
  }
}


// Auto-update cart when quantity input changes
document.addEventListener('DOMContentLoaded', function() {
  const qtyInputs = document.querySelectorAll('.qty-input');
  qtyInputs.forEach(input => {
    input.addEventListener('change', function() {
      document.getElementById('update-cart-btn').click();
    });
  });
  
  
  // Handle Enter key on discount code
  const discountInput = document.getElementById('discount-code');
  if (discountInput) {
    discountInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyDiscount();
      }
    });
  }
});
</script>