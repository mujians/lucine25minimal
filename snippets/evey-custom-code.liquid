<script>
  // Function to show/hide date selection message
  function showDateSelectionMessage(show) {
    let messageElement = document.getElementById('evey-date-selection-message');
    if (show) {
      if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'evey-date-selection-message';
        messageElement.className = 'sketch-card sketch seed-alert';
        messageElement.style.cssText = `
          margin: 1rem 0;
          padding: 1rem;
          background: rgba(255, 179, 0, 0.1);
          border: 2px dashed #ffb300;
          border-radius: 8px;
          text-align: center;
          color: #d32f2f;
          font-weight: 600;
          position: relative;
        `;
        messageElement.innerHTML = `
          <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; pointer-events: none;">
            <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="8 6 4 10" stroke="#ffb300" opacity="0.7"/>
          </svg>
          <div style="position: relative; z-index: 1;">
            üìÖ <strong>Prima seleziona data e ora</strong> cliccando su "Seleziona data e ora d'ingresso" per abilitare la selezione delle quantit√†
          </div>
        `;
        const eveyVariants = document.querySelector('.evey__variants');
        if (eveyVariants) {
          eveyVariants.parentNode.insertBefore(messageElement, eveyVariants);
        }
      }
      messageElement.style.display = 'block';
    } else if (messageElement) {
      messageElement.style.display = 'none';
    }
  }

   function blockMultiTicket(){
    const fetchEventId = document.querySelector('input[name="properties[_event_id]"]');
    const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
    const eveyVariants = document.querySelector('.evey__variants');
    const fetchEventIdobserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
          
        if (document.querySelector('input[name="properties[_event_id]"]').value == '') {
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            showDateSelectionMessage(true);
            }else{
                eveyVariantContainers.forEach(container => {
                  container.style.pointerEvents = 'all';
                  container.style.opacity = '1';
                  container.style.filter = 'none';
                });
                eveyVariants.style.cursor = 'auto';
                showDateSelectionMessage(false);
            }
      });
    });
    
    const fetchEventIdconfig = {
      attributes: true,
      childList: true,
      characterData: true,
      subtree: true
    };
    
    fetchEventIdobserver.observe(fetchEventId, fetchEventIdconfig);

  }

  
  const fetchEveyMetaData = {{ product.metafields.evey.event.value | default: product.metafields.evey.event | json }};
  if (fetchEveyMetaData && fetchEveyMetaData.date_type === "recurring") {
    let productBlocks = document.querySelector("#MainContent");
    let pbObserver = new MutationObserver(function () {
        // const checkForEveyScheduler = document.querySelector('#evey-schedule-calendar-modal');
        const fetchEventId = document.querySelector('input[name="properties[_event_id]"]')
        const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
        const eveyVariants = document.querySelector('.evey__variants');
        if (eveyVariantContainers && eveyVariants && fetchEventId) {
            pbObserver.disconnect();
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            showDateSelectionMessage(true);
            blockMultiTicket();
        }
    });

    pbObserver.observe(productBlocks, { attributes: false, childList: true, subtree: true });
  }

  // Add tooltips to ticket types
  function addTicketTooltips() {
    const ticketInfo = {
      'Intero': 'Biglietto standard per adulti. Include l\'accesso completo al parco nel giorno e orario selezionato.',
      'Ridotto': 'Per bambini 3-12 anni e persone con disabilit√†. Include accompagnatore gratuito per disabili con accesso prioritario.',
      'SaltaFila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.',
      'Saltafila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.'
    };

    setTimeout(() => {
      document.querySelectorAll('.evey__variant-name').forEach(nameElement => {
        const ticketType = nameElement.textContent.trim();
        if (ticketInfo[ticketType] && !nameElement.querySelector('.ticket-tooltip')) {
          nameElement.style.position = 'relative';
          
          const tooltip = document.createElement('div');
          tooltip.className = 'ticket-tooltip';
          tooltip.textContent = ticketInfo[ticketType];
          
          nameElement.appendChild(tooltip);
        }
      });
    }, 1000);
  }

  // Initialize tooltips when page loads and when Evey loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addTicketTooltips);
  } else {
    addTicketTooltips();
  }

  // Re-add tooltips when Evey content changes
  setTimeout(addTicketTooltips, 2000);
</script>

<style>
/* Enhanced UX for disabled Evey elements */
.evey__multi-variant-selector button[type="submit"][name="add"]:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  position: relative;
}

/* Fix quantity button icons visibility */
.evey__variant-container .quantity__button svg,
.evey__variant-container .quantity__button .icon {
  width: 16px !important;
  height: 16px !important;
  stroke: currentColor !important;
  fill: currentColor !important;
  stroke-width: 2 !important;
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}

.evey__variant-container .quantity__button {
  background: #2e7d32 !important;
  border: 1px solid #2e7d32 !important;
  color: white !important;
  border-radius: 4px !important;
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Simple note above add to cart button */
.evey__multi-variant-selector::before {
  content: "üí° Prima seleziona data, ora e quantit√† dei biglietti";
  display: block;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  font-size: 13px;
  color: #666;
  text-align: center;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: rgba(102, 102, 102, 0.08);
  border-radius: 6px;
  font-weight: 400;
}

/* Fix excessive padding on product media */
.product__media.media.media--transparent {
  padding-top: 20px !important;
}

/* Improve overall interface clarity with better spacing */
.product__info-wrapper {
  background: rgba(255, 255, 255, 0.02);
  border-radius: 12px;
  padding: 2rem;
  backdrop-filter: blur(10px);
}

/* Mobile optimizations */
@media screen and (max-width: 768px) {
  .product__media {
    display: none !important;
  }
  
  .ticket_guide,
  .collapsible-row {
    display: none !important;
  }
  
  .sketch-card:not(.open-ticket):not(.seed-alert) {
    display: none !important;
  }
  
  .product__info-wrapper {
    padding: 1rem;
  }
}

/* Improved Open ticket box styling */
.open-ticket-card,
.sketch-card.seed-9 {
  background: linear-gradient(135deg, rgba(255,179,0,0.1) 0%, rgba(211,47,47,0.05) 100%) !important;
  border: 2px solid #ffb300 !important;
  border-radius: 16px !important;
  position: relative;
  overflow: hidden;
}

.open-ticket-card::before,
.sketch-card.seed-9::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 100px;
  height: 100px;
  background: radial-gradient(circle, rgba(255,179,0,0.2) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

/* Tooltip system for ticket types */
.evey__variant-name {
  position: relative;
  cursor: help;
}

.evey__variant-name::after {
  content: '‚ÑπÔ∏è';
  font-size: 12px;
  margin-left: 6px;
  opacity: 0.7;
}

.evey__variant-container:hover .ticket-tooltip {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.ticket-tooltip {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.4;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  margin-top: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.ticket-tooltip::before {
  content: '';
  position: absolute;
  top: -6px;
  left: 20px;
  border: 6px solid transparent;
  border-bottom-color: rgba(0, 0, 0, 0.9);
}
</style>