<script>
  // Function to show/hide date selection message
  function showDateSelectionMessage(show) {
    let messageElement = document.getElementById('evey-date-selection-message');
    if (show) {
      if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'evey-date-selection-message';
        messageElement.className = 'sketch-card sketch seed-alert';
        messageElement.style.cssText = `
          margin: 1rem 0;
          padding: 1rem;
          background: rgba(255, 179, 0, 0.1);
          border: 2px dashed #ffb300;
          border-radius: 8px;
          text-align: center;
          color: #d32f2f;
          font-weight: 600;
          position: relative;
        `;
        messageElement.innerHTML = `
          <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; pointer-events: none;">
            <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="8 6 4 10" stroke="#ffb300" opacity="0.7"/>
          </svg>
          <div style="position: relative; z-index: 1;">
            üìÖ <strong>Prima seleziona data e ora</strong> cliccando su "Seleziona data e ora d'ingresso" per abilitare la selezione delle quantit√†
          </div>
        `;
        const eveyVariants = document.querySelector('.evey__variants');
        if (eveyVariants) {
          eveyVariants.parentNode.insertBefore(messageElement, eveyVariants);
        }
      }
      messageElement.style.display = 'block';
    } else if (messageElement) {
      messageElement.style.display = 'none';
    }
  }

   function blockMultiTicket(){
    const fetchEventId = document.querySelector('input[name="properties[_event_id]"]');
    const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
    const eveyVariants = document.querySelector('.evey__variants');
    const fetchEventIdobserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
          
        if (document.querySelector('input[name="properties[_event_id]"]').value == '') {
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            showDateSelectionMessage(true);
            }else{
                eveyVariantContainers.forEach(container => {
                  container.style.pointerEvents = 'all';
                  container.style.opacity = '1';
                  container.style.filter = 'none';
                });
                eveyVariants.style.cursor = 'auto';
                showDateSelectionMessage(false);
            }
      });
    });
    
    const fetchEventIdconfig = {
      attributes: true,
      childList: true,
      characterData: true,
      subtree: true
    };
    
    fetchEventIdobserver.observe(fetchEventId, fetchEventIdconfig);

  }

  
  const fetchEveyMetaData = {{ product.metafields.evey.event.value | default: product.metafields.evey.event | json }};
  if (fetchEveyMetaData && fetchEveyMetaData.date_type === "recurring") {
    let productBlocks = document.querySelector("#MainContent");
    let pbObserver = new MutationObserver(function () {
        // const checkForEveyScheduler = document.querySelector('#evey-schedule-calendar-modal');
        const fetchEventId = document.querySelector('input[name="properties[_event_id]"]')
        const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
        const eveyVariants = document.querySelector('.evey__variants');
        if (eveyVariantContainers && eveyVariants && fetchEventId) {
            pbObserver.disconnect();
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            showDateSelectionMessage(true);
            blockMultiTicket();
        }
    });

    pbObserver.observe(productBlocks, { attributes: false, childList: true, subtree: true });
  }

  // Add tooltips to ticket types
  function addTicketTooltips() {
    const ticketInfo = {
      'Intero': 'Biglietto standard per adulti. Include l\'accesso completo al parco nel giorno e orario selezionato.',
      'Ridotto': 'Per bambini 3-12 anni e persone con disabilit√†. Include accompagnatore gratuito per disabili con accesso prioritario.',
      'SaltaFila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.',
      'Saltafila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.'
    };

    setTimeout(() => {
      document.querySelectorAll('.evey__variant-name').forEach(nameElement => {
        const ticketType = nameElement.textContent.trim();
        if (ticketInfo[ticketType] && !nameElement.querySelector('.ticket-tooltip')) {
          nameElement.style.position = 'relative';
          
          const tooltip = document.createElement('div');
          tooltip.className = 'ticket-tooltip';
          tooltip.textContent = ticketInfo[ticketType];
          
          nameElement.appendChild(tooltip);
        }
      });
    }, 1000);
  }

  // Initialize tooltips when page loads and when Evey loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addTicketTooltips);
  } else {
    addTicketTooltips();
  }

  // Re-add tooltips when Evey content changes
  setTimeout(addTicketTooltips, 2000);

  // Replace open ticket box with interactive form
  function addOpenTicketForm() {
    const openTicketBox = document.querySelector('.sketch-card.seed-9');
    if (openTicketBox && !document.getElementById('open-ticket-form')) {
      fetch('/products/biglietto-open-2024-2025.js')
        .then(response => {
          if (!response.ok) {
            throw new Error('Product not found');
          }
          return response.json();
        })
        .then(product => {
          if (!product || !product.price || !product.variants || !product.variants[0]) {
            throw new Error('Invalid product data');
          }
          
          const price = (product.price / 100).toFixed(2).replace('.', ',');
          const variantId = product.variants[0].id;
          
          const formHTML = `
            <div class="open-ticket-card" id="open-ticket-form" style="background: linear-gradient(135deg, rgba(255,179,0,0.1) 0%, rgba(211,47,47,0.05) 100%); border: 2px solid #ffb300; border-radius: 16px; padding: 1.5rem; margin: 2rem 0; position: relative; overflow: visible;">
              <div style="position: absolute; top: -30px; right: -30px; width: 60px; height: 60px; background: radial-gradient(circle, rgba(255,179,0,0.2) 0%, transparent 70%); border-radius: 50%;"></div>
              
              <form id="open-ticket-product-form" action="/cart/add" method="post" enctype="multipart/form-data">
                <div class="open-form-content" style="display: flex; align-items: flex-start; gap: 1.5rem; position: relative; z-index: 1;">
                  <div class="open-image" style="flex-shrink: 0;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ffb300; padding: 3px; background: white;">
                      <img src="https://cdn.shopify.com/s/files/1/0605/2983/6205/files/open-pass.jpg?v=1730481582" alt="Biglietto Open" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    </div>
                  </div>
                  
                  <div class="open-details" style="flex: 1; min-width: 0;">
                    <div class="open-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                      <span style="font-size: 1.5rem;">ü•á</span>
                      <h3 style="color: #ffb300; margin: 0; font-weight: 700; font-size: 1.25rem;">Biglietto Open</h3>
                      <span style="background: #d32f2f; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">ESCLUSIVO</span>
                    </div>
                    
                    <p style="color: rgba(255,255,255,0.9); line-height: 1.4; margin: 0 0 1rem 0; font-size: 14px;">Pass premium <strong>senza prenotazione</strong> - accesso libero.</p>
                    
                    <div class="open-pricing" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
                      <div style="display: flex; align-items: center; gap: 0.25rem;">
                        <span style="color: #ffb300; font-weight: 700; font-size: 1.25rem;">‚Ç¨${price}</span>
                      </div>
                    </div>
                    
                    <div class="open-actions" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                      <div class="qty-selector" style="display: flex; align-items: center; border: 1px solid rgba(255,179,0,0.3); border-radius: 6px; background: rgba(255,255,255,0.05);">
                        <button type="button" class="open-qty-btn" data-action="minus" style="background: none; border: none; color: #ffb300; font-size: 16px; font-weight: bold; padding: 8px 10px; cursor: pointer;">‚àí</button>
                        <input type="number" name="quantity" id="open-quantity" value="1" min="1" max="10" style="background: none; border: none; text-align: center; width: 40px; color: white; font-size: 14px; font-weight: 600;">
                        <button type="button" class="open-qty-btn" data-action="plus" style="background: none; border: none; color: #ffb300; font-size: 16px; font-weight: bold; padding: 8px 10px; cursor: pointer;">+</button>
                      </div>
                      
                      <input type="hidden" name="id" value="${variantId}">
                      <button type="submit" id="open-add-to-cart" style="background: linear-gradient(45deg, #ffb300, #d32f2f); color: white; padding: 10px 16px; border: none; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 14px; box-shadow: 0 3px 10px rgba(255,179,0,0.3); cursor: pointer; transition: transform 0.2s ease; flex: 1; min-width: 140px; justify-content: center;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                        <span>üõí</span> <span id="open-cart-text">Aggiungi al Carrello</span>
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          `;
          
          openTicketBox.outerHTML = formHTML;
          
          // Initialize form functionality after insertion
          setTimeout(initializeOpenTicketForm, 100);
        })
        .catch(error => {
          console.error('Open ticket product not available:', error);
          // Show error message instead of fake pricing
          const errorHTML = `
            <div class="open-ticket-error" style="background: rgba(211,47,47,0.1); border: 2px solid #d32f2f; border-radius: 16px; padding: 2rem; margin: 2rem 0; text-align: center;">
              <div style="color: #d32f2f; font-size: 1.5rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
              <h3 style="color: #d32f2f; margin: 0 0 1rem 0;">Biglietto Open temporaneamente non disponibile</h3>
              <p style="color: rgba(255,255,255,0.8); margin: 0 0 1.5rem 0;">Il prodotto non √® attualmente disponibile per l'acquisto online.</p>
              <a href="https://lucinedinatale.it/products/biglietto-open-2024-2025" style="background: #d32f2f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
                Visita la pagina prodotto
              </a>
            </div>
          `;
          
          openTicketBox.outerHTML = errorHTML;
        });
    }
  }

  function initializeOpenTicketForm() {
    // Quantity controls
    document.querySelectorAll('.open-qty-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const input = document.getElementById('open-quantity');
        const action = this.getAttribute('data-action');
        let value = parseInt(input.value) || 1;
        
        if (action === 'plus' && value < 10) {
          input.value = value + 1;
        } else if (action === 'minus' && value > 1) {
          input.value = value - 1;
        }
      });
    });

    // Form submission
    const form = document.getElementById('open-ticket-product-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const addBtn = document.getElementById('open-add-to-cart');
        const btnText = document.getElementById('open-cart-text');
        
        if (addBtn) addBtn.disabled = true;
        if (btnText) btnText.textContent = 'Aggiungendo...';
        
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (btnText) btnText.textContent = 'Aggiunto! ‚úì';
          setTimeout(() => {
            window.location.href = '/cart';
          }, 800);
        })
        .catch(error => {
          console.error('Error:', error);
          if (btnText) btnText.textContent = 'Errore - Riprova';
          if (addBtn) addBtn.disabled = false;
          setTimeout(() => {
            if (btnText) btnText.textContent = 'Aggiungi al Carrello';
          }, 2000);
        });
      });
    }
  }

  // Initialize Open ticket form when page loads
  setTimeout(addOpenTicketForm, 1500);
</script>

<style>
/* Enhanced UX for disabled Evey elements */
.evey__multi-variant-selector button[type="submit"][name="add"]:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  position: relative;
}

/* Fix quantity button icons visibility */
.evey__variant-container .quantity__button svg,
.evey__variant-container .quantity__button .icon {
  width: 16px !important;
  height: 16px !important;
  stroke: currentColor !important;
  fill: currentColor !important;
  stroke-width: 2 !important;
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}

.evey__variant-container .quantity__button {
  background: #2e7d32 !important;
  border: 1px solid #2e7d32 !important;
  color: white !important;
  border-radius: 4px !important;
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Simple note above add to cart button */
.evey__multi-variant-selector::before {
  content: "üí° Prima seleziona data, ora e quantit√† dei biglietti";
  display: block;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  font-size: 13px;
  color: #666;
  text-align: center;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: rgba(102, 102, 102, 0.08);
  border-radius: 6px;
  font-weight: 400;
}

/* Fix excessive padding on product media */
.product__media.media.media--transparent {
  padding-top: 20px !important;
}

/* Improve overall interface clarity with better spacing */
.product__info-wrapper {
  background: rgba(255, 255, 255, 0.02);
  border-radius: 12px;
  padding: 2rem;
  backdrop-filter: blur(10px);
}

/* Mobile optimizations */
@media screen and (max-width: 768px) {
  .product__media {
    display: none !important;
  }
  
  .ticket_guide,
  .collapsible-row {
    display: none !important;
  }
  
  .sketch-card:not(.open-ticket):not(.seed-alert) {
    display: none !important;
  }
  
  .product__info-wrapper {
    padding: 1rem;
  }
}

/* Improved Open ticket box styling */
.open-ticket-card,
.sketch-card.seed-9 {
  background: linear-gradient(135deg, rgba(255,179,0,0.1) 0%, rgba(211,47,47,0.05) 100%) !important;
  border: 2px solid #ffb300 !important;
  border-radius: 16px !important;
  position: relative;
  overflow: hidden;
}

.open-ticket-card::before,
.sketch-card.seed-9::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 100px;
  height: 100px;
  background: radial-gradient(circle, rgba(255,179,0,0.2) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

/* Tooltip system for ticket types */
.evey__variant-name {
  position: relative;
  cursor: help;
}

.evey__variant-name::after {
  content: '‚ÑπÔ∏è';
  font-size: 12px;
  margin-left: 6px;
  opacity: 0.7;
}

.evey__variant-container:hover .ticket-tooltip {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.ticket-tooltip {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.4;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  margin-top: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.ticket-tooltip::before {
  content: '';
  position: absolute;
  top: -6px;
  left: 20px;
  border: 6px solid transparent;
  border-bottom-color: rgba(0, 0, 0, 0.9);
}

/* Enhanced Open Ticket responsive design */
@media screen and (max-width: 768px) {
  .open-ticket-card .open-form-content {
    flex-direction: column !important;
    align-items: center !important;
    text-align: center;
    gap: 1rem !important;
  }
  
  .open-ticket-card .open-image {
    align-self: center;
  }
  
  .open-ticket-card .open-header {
    justify-content: center !important;
  }
  
  .open-ticket-card .open-pricing {
    justify-content: center !important;
  }
  
  .open-ticket-card .open-actions {
    justify-content: center !important;
    width: 100%;
  }
  
  .open-ticket-card .qty-selector {
    min-width: 120px;
  }
  
  .open-ticket-card #open-add-to-cart {
    min-width: 160px !important;
  }
}

@media screen and (max-width: 480px) {
  .open-ticket-card {
    padding: 1rem !important;
    margin: 1rem 0 !important;
  }
  
  .open-ticket-card .open-actions {
    flex-direction: column !important;
    gap: 0.75rem !important;
  }
  
  .open-ticket-card #open-add-to-cart {
    width: 100% !important;
    min-width: unset !important;
  }
}
</style>