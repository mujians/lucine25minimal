<script>

   function blockMultiTicket(){
    const fetchEventId = document.querySelector('input[name="properties[_event_id]"]');
    const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
    const eveyVariants = document.querySelector('.evey__variants');
    const fetchEventIdobserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
          
        if (document.querySelector('input[name="properties[_event_id]"]').value == '') {
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            }else{
                eveyVariantContainers.forEach(container => {
                  container.style.pointerEvents = 'all';
                  container.style.opacity = '1';
                  container.style.filter = 'none';
                });
                eveyVariants.style.cursor = 'auto';
            }
      });
    });
    
    const fetchEventIdconfig = {
      attributes: true,
      childList: true,
      characterData: true,
      subtree: true
    };
    
    fetchEventIdobserver.observe(fetchEventId, fetchEventIdconfig);

  }

  
  const fetchEveyMetaData = {{ product.metafields.evey.event.value | default: product.metafields.evey.event | json }};
  if (fetchEveyMetaData && fetchEveyMetaData.date_type === "recurring") {
    let productBlocks = document.querySelector("#MainContent");
    let pbObserver = new MutationObserver(function () {
        // const checkForEveyScheduler = document.querySelector('#evey-schedule-calendar-modal');
        const fetchEventId = document.querySelector('input[name="properties[_event_id]"]')
        const eveyVariantContainers = document.querySelectorAll('.evey__variant-container');
        const eveyVariants = document.querySelector('.evey__variants');
        if (eveyVariantContainers && eveyVariants && fetchEventId) {
            pbObserver.disconnect();
            
            // Add our custom elements when Evey loads
            setTimeout(() => {
              addBigliettParcoTitle();
              addTicketTooltips();
            }, 2000);
            
            eveyVariantContainers.forEach(container => {
              container.style.pointerEvents = 'none';
              container.style.opacity = '0.6';
              container.style.filter = 'grayscale(50%)';
            });
            eveyVariants.style.cursor = 'not-allowed';
            blockMultiTicket();
        }
    });

    pbObserver.observe(productBlocks, { attributes: false, childList: true, subtree: true });
  }

  // Add "Biglietti Parco" title inside Evey box - more robust approach
  function addBigliettParcoTitle() {
    const eveySelectors = [
      '.evey__multi-variant-selector',
      '.evey__variants',
      '[class*="evey"]'
    ];
    
    for (let selector of eveySelectors) {
      const eveyContainer = document.querySelector(selector);
      if (eveyContainer && !document.querySelector('.biglietti-parco-title')) {
        const title = document.createElement('h3');
        title.className = 'biglietti-parco-title';
        title.style.cssText = `
          color: #ffb300;
          font-size: 1.5rem;
          font-weight: 700;
          margin: 0 0 1.5rem 0;
          text-align: center;
          display: block;
        `;
        title.textContent = 'Biglietti Parco';
        
        eveyContainer.insertBefore(title, eveyContainer.firstChild);
        break;
      }
    }
  }
  
  // Backup title addition (in case main system doesn't work)
  setTimeout(() => {
    if (!document.querySelector('.biglietti-parco-title')) {
      addBigliettParcoTitle();
    }
  }, 4000);

  // Add smart tooltips - hover on desktop, click on mobile
  function addTicketTooltips() {
    const ticketInfo = {
      'Intero': 'Biglietto standard per adulti. Include l\'accesso completo al parco nel giorno e orario selezionato.',
      'Ridotto': 'Per bambini 3-12 anni e disabili. L\'accompagnatore di una persona disabile può anch\'esso acquistare un biglietto ridotto (1 disabile + 1 accompagnatore = 2 biglietti ridotti). Accesso prioritario.',
      'SaltaFila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.',
      'Saltafila': 'Accesso prioritario senza code all\'ingresso. Include tutti i vantaggi del biglietto intero.'
    };

    setTimeout(() => {
      document.querySelectorAll('.evey__variant-name').forEach(nameElement => {
        const ticketType = nameElement.textContent.trim();
        if (ticketInfo[ticketType] && !nameElement.querySelector('.ticket-tooltip')) {
          nameElement.style.position = 'relative';
          
          const tooltip = document.createElement('div');
          tooltip.className = 'ticket-tooltip';
          tooltip.textContent = ticketInfo[ticketType];
          
          nameElement.appendChild(tooltip);
          
          // Mobile: click to show/hide
          if (window.innerWidth <= 768) {
            nameElement.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              // Hide all other tooltips first
              document.querySelectorAll('.ticket-tooltip').forEach(t => {
                if (t !== tooltip) {
                  t.classList.remove('show-mobile');
                }
              });
              
              // Toggle this tooltip
              tooltip.classList.toggle('show-mobile');
            });
          }
        }
      });
    }, 1000);
  }

  // Backup tooltip addition (in case main system doesn't work)
  setTimeout(() => {
    if (document.querySelectorAll('.ticket-tooltip').length === 0) {
      addTicketTooltips();
    }
  }, 4500);

  // Simple open ticket box - no loading states or complex logic
  function addOpenTicketForm() {
    const openTicketBox = document.querySelector('.sketch-card.seed-9');
    if (openTicketBox && !document.getElementById('open-ticket-form')) {
      // Direct creation - no fetching, no loading states
      const variantId = '10082871050579'; // Known working variant ID
      
      const formHTML = `
        <div class="open-ticket-card" id="open-ticket-form" style="background: linear-gradient(135deg, rgba(255,179,0,0.1) 0%, rgba(211,47,47,0.05) 100%); border: 2px solid #ffb300; border-radius: 16px; padding: 1.5rem; margin: 2rem 0; position: relative; overflow: visible;">
          <div style="position: absolute; top: -30px; right: -30px; width: 60px; height: 60px; background: radial-gradient(circle, rgba(255,179,0,0.2) 0%, transparent 70%); border-radius: 50%;"></div>
          
          <form id="open-ticket-product-form" action="/cart/add" method="post" enctype="multipart/form-data">
            <div class="open-form-content" style="position: relative; z-index: 1;">
              <div class="open-details" style="width: 100%;">
                <div class="open-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                  <h3 style="color: #ffb300; margin: 0; font-weight: 700; font-size: 1.5rem;">Biglietto Open</h3>
                  <span style="background: #d32f2f; color: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;">ESCLUSIVO</span>
                </div>
                
                <p style="color: rgba(255,255,255,0.9); line-height: 1.5; margin: 0 0 1rem 0; font-size: 16px;">
                  <strong>Pass esclusivo senza prenotazione</strong> - accedi quando preferisci!<br>
                  Nessun vincolo di orario o data specifica<br>
                  Accesso prioritario ed immediato al parco<br>
                  Esperienza premium senza code
                </p>
                
                <div class="open-pricing" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
                  <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="color: #ffb300; font-weight: 700; font-size: 1.25rem;">€15,00</span>
                  </div>
                </div>
                
                <div class="open-actions" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                  <quantity-input class="quantity cart-quantity">
                    <button class="quantity__button no-js-hidden" name="minus" type="button">
                      <span class="visually-hidden">Diminuisci quantità</span>
                      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" role="presentation" class="icon icon-minus" fill="none" viewBox="0 0 10 2">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M.5 1C.5.776.672.604.896.604h8.208a.896.896 0 010 1.792H.896A.896.896 0 01.5 1z" fill="currentColor"></path>
                      </svg>
                    </button>
                    <input class="quantity__input" type="number" name="quantity" value="1" min="1" max="10" id="open-quantity">
                    <button class="quantity__button no-js-hidden" name="plus" type="button">
                      <span class="visually-hidden">Aumenta quantità</span>
                      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" role="presentation" class="icon icon-plus" fill="none" viewBox="0 0 10 10">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1 4.51a.5.5 0 000 1h3.5l.01 3.5a.5.5 0 001-.01V5.5l3.5-.01a.5.5 0 00-.01-1H5.5L5.49.99a.5.5 0 00-1 .01v3.5l-3.5.01H1z" fill="currentColor"></path>
                      </svg>
                    </button>
                  </quantity-input>
                  
                  <input type="hidden" name="id" value="${variantId}">
                  <button type="submit" id="open-add-to-cart" style="background: #2e7d32; color: white; border: 2px solid #2e7d32; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 600; transition: all 0.3s ease; font-size: 1rem; cursor: pointer; flex: 1; min-width: 160px; text-align: center;" onmouseover="this.style.background='#d32f2f'; this.style.borderColor='#d32f2f';" onmouseout="this.style.background='#2e7d32'; this.style.borderColor='#2e7d32';">
                    <span id="open-cart-text">Aggiungi al Carrello</span>
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      `;
      
      // Direct replacement - no transitions or delays
      openTicketBox.outerHTML = formHTML;
      // Initialize form functionality immediately
      setTimeout(initializeOpenTicketForm, 100);
    }
  }

  function initializeOpenTicketForm() {
    // Quantity controls using standard Shopify quantity__button class
    document.querySelectorAll('#open-ticket-form .quantity__button').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const input = document.getElementById('open-quantity');
        const action = this.getAttribute('data-action') || this.getAttribute('name');
        let value = parseInt(input.value) || 1;
        
        if (action === 'plus' && value < 10) {
          input.value = value + 1;
        } else if (action === 'minus' && value > 1) {
          input.value = value - 1;
        }
      });
    });

    // Form submission
    const form = document.getElementById('open-ticket-product-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const addBtn = document.getElementById('open-add-to-cart');
        const btnText = document.getElementById('open-cart-text');
        
        if (addBtn) addBtn.disabled = true;
        if (btnText) btnText.textContent = 'Aggiungendo...';
        
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (btnText) btnText.textContent = 'Aggiunto! ✓';
          setTimeout(() => {
            window.location.href = '/cart';
          }, 800);
        })
        .catch(error => {
          console.error('Error:', error);
          if (btnText) btnText.textContent = 'Errore - Riprova';
          if (addBtn) addBtn.disabled = false;
          setTimeout(() => {
            if (btnText) btnText.textContent = 'Aggiungi al Carrello';
          }, 2000);
        });
      });
    }
  }

  // Initialize Open ticket form when page loads (faster timing)
  setTimeout(addOpenTicketForm, 800);

  // Replace ticket guide with collapsible version
  function replaceTicketGuide() {
    const ticketGuide = document.querySelector('[style*="Guida ai Biglietti"]');
    if (ticketGuide && ticketGuide.innerHTML.includes('Guida ai Biglietti')) {
      fetch('/snippets/ticket-guide-collapsible.liquid')
        .then(response => response.text())
        .then(html => {
          ticketGuide.outerHTML = html;
        })
        .catch(error => console.log('Could not load collapsible guide'));
    }
  }
  
  // Initialize collapsible guide
  setTimeout(replaceTicketGuide, 500);
</script>

<style>
/* Make open ticket quantity buttons match Evey exactly */
#open-ticket-form .quantity {
  width: 140px !important;
  height: 45px !important;
  border: 1.11111px solid rgba(18, 18, 18, 0.08) !important;
  border-radius: 0px !important;
  font-size: 18px !important;
  line-height: 30.6px !important;
  color: rgb(255, 255, 255) !important;
  font-family: "Providence Sans", -apple-system, "system-ui", "Segoe UI", "Helvetica Neue", sans-serif !important;
  background: rgba(255, 255, 255, 0.02) !important;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
}

#open-ticket-form .quantity__input {
  height: 45px !important;
  line-height: 30.6px !important;
  font-size: 18px !important;
  color: rgb(255, 255, 255) !important;
  font-family: "Providence Sans", -apple-system, "system-ui", "Segoe UI", "Helvetica Neue", sans-serif !important;
  border: none !important;
  background: transparent !important;
  text-align: center !important;
}

#open-ticket-form .quantity__button {
  height: 45px !important;
  width: 27px !important;
  font-size: 18px !important;
  color: rgb(255, 255, 255) !important;
  background: transparent !important;
  border: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
}

#open-ticket-form .quantity__button svg {
  width: 16px !important;
  height: 16px !important;
  fill: rgb(255, 255, 255) !important;
  stroke: none !important;
}
</style>

<style>
/* Enhanced UX for disabled Evey elements */
.evey__multi-variant-selector button[type="submit"][name="add"]:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  position: relative;
}

/* Quantity buttons - let Shopify handle them naturally */

/* Remove hint box - layout is now clear enough */

/* Keep Evey button more original - minimal changes */
button[data-evey-trigger] {
  /* Let Evey handle the button text naturally */
}

/* Ensure "Add to Cart" button text is in Italian */
button[name="add"][type="submit"] {
  font-size: 0 !important;
  position: relative;
}

button[name="add"][type="submit"]::after {
  content: "Aggiungi al Carrello";
  font-size: 16px !important;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  color: inherit;
  width: 100%;
  height: 100%;
}

/* Product media padding removed - not needed as media is hidden */

/* Card style ONLY for Evey block */
.evey__multi-variant-selector {
  background: rgba(255, 255, 255, 0.05) !important;
  border-radius: 20px !important;
  padding: 2rem !important;
  backdrop-filter: blur(15px) !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
  margin: 2rem 0 !important;
  position: relative;
  overflow: visible;
}

/* Add a subtle glow effect to Evey card */
.evey__multi-variant-selector::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, #ffb300, #d32f2f, #2e7d32, #ffb300);
  border-radius: 20px;
  opacity: 0.3;
  z-index: -1;
  filter: blur(10px);
}

/* Style custom liquid blocks - keep them full width unless they are purchase-related */
.shopify-block[id*="custom_liquid"],
.product-block__content {
  background: transparent !important;
  max-width: 100% !important;
  padding: 1.5rem 0 !important;
}

/* Only specific alert/important boxes get card treatment */
.alert-box,
.info-box-arancio,
.info-box {
  background: rgba(255, 255, 255, 0.05) !important;
  border-radius: 16px !important;
  padding: 1.5rem !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
  margin: 1.5rem 0 !important;
}

/* Ticket guide cards - keep them in a nice grid */
.card-container {
  max-width: 100% !important;
  background: transparent !important;
}

.card-container .card {
  background: rgba(255, 255, 255, 0.03) !important;
  border: 1px solid rgba(255, 255, 255, 0.08) !important;
  border-radius: 12px !important;
  padding: 1.5rem !important;
  margin-bottom: 1rem !important;
  transition: all 0.3s ease;
}

.card-container .card:hover {
  background: rgba(255, 255, 255, 0.06) !important;
  transform: translateX(5px);
  border-color: rgba(255, 179, 0, 0.3) !important;
}

/* Mobile optimizations - media hiding removed as handled in main-product.liquid */
@media screen and (max-width: 768px) {
  .ticket_guide,
  .collapsible-row {
    display: none !important;
  }
  
  .sketch-card:not(.open-ticket):not(.seed-alert) {
    display: none !important;
  }
  
  .product__info-wrapper {
    padding: 1rem;
  }
}

/* Improved Open ticket box styling */
.open-ticket-card,
.sketch-card.seed-9 {
  background: linear-gradient(135deg, rgba(255,179,0,0.1) 0%, rgba(211,47,47,0.05) 100%) !important;
  border: 2px solid #ffb300 !important;
  border-radius: 16px !important;
  position: relative;
  overflow: hidden;
}

.open-ticket-card::before,
.sketch-card.seed-9::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 100px;
  height: 100px;
  background: radial-gradient(circle, rgba(255,179,0,0.2) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

/* Simple tooltip system */
.evey__variant-name {
  position: relative;
  cursor: help;
}

.evey__variant-name::after {
  content: 'ℹ️';
  font-size: 12px;
  margin-left: 6px;
  opacity: 0.7;
}

/* Desktop: hover only on variant name text, not quantity buttons */
@media (min-width: 769px) {
  .evey__variant-name:hover .ticket-tooltip {
    opacity: 1;
    visibility: visible;
  }
}

/* Mobile: click to show/hide */
@media (max-width: 768px) {
  .ticket-tooltip.show-mobile {
    opacity: 1;
    visibility: visible;
  }
}

.ticket-tooltip {
  position: absolute;
  top: 100%;
  left: 0;
  min-width: 200px;
  max-width: 300px;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.4;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* Prevent flash of old content */
.sketch-card.seed-9 {
  opacity: 1;
  transition: opacity 0.3s ease;
}

.open-ticket-loading {
  opacity: 0.5 !important;
}

/* Enhanced Open Ticket responsive design */
@media screen and (max-width: 768px) {
  .open-ticket-card .open-form-content {
    flex-direction: column !important;
    align-items: center !important;
    text-align: center;
    gap: 1rem !important;
  }
  
  .open-ticket-card .open-image {
    align-self: center;
  }
  
  .open-ticket-card .open-header {
    justify-content: center !important;
  }
  
  .open-ticket-card .open-pricing {
    justify-content: center !important;
  }
  
  .open-ticket-card .open-actions {
    justify-content: center !important;
    width: 100%;
  }
  
  .open-ticket-card .qty-selector {
    min-width: 120px;
  }
  
  .open-ticket-card #open-add-to-cart {
    min-width: 160px !important;
  }
}

@media screen and (max-width: 480px) {
  .open-ticket-card {
    padding: 1rem !important;
    margin: 1rem 0 !important;
  }
  
  .open-ticket-card .open-actions {
    flex-direction: column !important;
    gap: 0.75rem !important;
  }
  
  .open-ticket-card #open-add-to-cart {
    width: 100% !important;
    min-width: unset !important;
  }
}
</style>