<div class="formatted-content">
  <h1>Domande Frequenti</h1>
  <p style="font-size: 1.188rem;">Risposte alle domande piÃ¹ comuni sui <span class="faq-highlight">biglietti, orari e servizi</span>.</p>

    <h2>Non trovi quello che cerchi?</h2>
<!-- FAQ CHATBOT AI - Snippet Shopify -->
<style>
/* Chatbot Container */
.faq-chatbot {
  margin: 3rem 0;
  padding: 0;
}

.chatbot-card {
  background: rgba(15, 47, 31, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  position: relative;
  overflow: hidden;
}

/* Chat Messages Area */
.chat-messages {
  min-height: 300px;
  max-height: 400px;
  overflow-y: auto;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  margin-bottom: 1rem;
  scroll-behavior: smooth;
}

.chat-message {
  margin-bottom: 1rem;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.chat-message.user {
  text-align: right;
}

.chat-message.bot {
  text-align: left;
}

.message-bubble {
  display: inline-block;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  max-width: 80%;
  font-size: 1.188rem;
  line-height: 1.5;
}

.user .message-bubble {
  background: rgba(212, 175, 55, 0.2);
  color: var(--christmas-gold);
  border: 1px solid var(--christmas-gold);
}

.bot .message-bubble {
  background: rgba(139, 195, 74, 0.1);
  color: var(--text-white);
  border: 1px solid var(--christmas-green);
}

/* Input Area */
.chat-input-area {
  display: flex;
  gap: 1rem;
}

.chat-input {
  flex: 1;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.2);
  color: var(--text-white);
  padding: 1rem;
  border-radius: 8px;
  font-size: 1.188rem;
  font-family: 'Providence Sans', -apple-system, sans-serif;
  transition: all 0.3s ease;
}

.chat-input:focus {
  outline: none;
  border-color: var(--christmas-green);
  background: rgba(255, 255, 255, 0.08);
}

.chat-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.chat-send-btn {
  background: var(--christmas-red);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 8px;
  font-size: 1.125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Providence Sans', -apple-system, sans-serif;
}

.chat-send-btn:hover {
  background: var(--christmas-green);
  transform: translateY(-2px);
}

.chat-send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Typing Indicator */
.typing-indicator {
  display: none;
  padding: 0.5rem 1rem;
  color: var(--text-gray);
  font-style: italic;
}

.typing-indicator.show {
  display: block;
}

.typing-indicator span {
  animation: blink 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0%, 60%, 100% { opacity: 0.3; }
  30% { opacity: 1; }
}

/* Welcome Message */
.chat-welcome {
  text-align: center;
  padding: 2rem;
  color: var(--text-gray);
}

.chat-welcome h4 {
  color: var(--christmas-green);
  font-family: 'Homemade Apple', cursive;
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

/* Suggestions */
.chat-suggestions {
  margin: 1rem 0;
  padding: 0 1rem;
}

.suggestions-label {
  font-size: 0.9rem;
  color: var(--text-gray);
  margin-bottom: 0.5rem;
  font-style: italic;
}

.suggestions-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.suggestion-btn {
  background: rgba(139, 195, 74, 0.15);
  color: var(--christmas-green);
  border: 1px solid var(--christmas-green);
  border-radius: 20px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'Providence Sans', -apple-system, sans-serif;
}

.suggestion-btn:hover {
  background: rgba(139, 195, 74, 0.25);
  transform: translateY(-1px);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .chat-messages {
    min-height: 250px;
    max-height: 350px;
  }
  
  .message-bubble {
    font-size: 1.125rem;
  }
  
  .chat-send-btn {
    padding: 1rem 1.5rem;
  }

  .suggestions-buttons {
    flex-direction: column;
  }
  
  .suggestion-btn {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
  }
}
</style>

<div class="faq-chatbot">
  <div class="sketch-card sketch seed-8">
    <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
      <defs>
        <filter id="wobble-chatbot-{{ section.id }}">
          <feTurbulence type="fractalNoise" baseFrequency="1.1" numOctaves="1" seed="19"></feTurbulence>
          <feDisplacementMap in="SourceGraphic" scale="1"></feDisplacementMap>
        </filter>
      </defs>
      <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="13 7 9 11 6 8" vector-effect="non-scaling-stroke" filter="url(#wobble-chatbot-{{ section.id }})"></rect>
    </svg>
    
    <h3 style="color: var(--christmas-red); margin-bottom: 1.5rem;">Chatta con l'Assistente delle Lucine</h3>
    
    <div class="chatbot-card">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-welcome">
          <h4>Ciao! âœ¨</h4>
          <p>Sono l'assistente delle Lucine di Natale. Chiedimi informazioni su biglietti, orari, parcheggi o qualsiasi cosa riguardi l'evento!</p>
        </div>
      </div>
      
      <div class="typing-indicator" id="typingIndicator">
        L'assistente sta scrivendo<span>.</span><span>.</span><span>.</span>
      </div>
      
      <div class="chat-input-area">
        <input 
          type="text" 
          class="chat-input" 
          id="chatInput" 
          placeholder="Fai una domanda..."
          onkeypress="if(event.key === 'Enter') sendMessage()"
        >
        <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
          Invia
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// CONFIGURAZIONE - Backend Vercel deployato
const BACKEND_URL = 'https://chatbot-backend-oxw60jhy4-brunos-projects-075c84f2.vercel.app/api/chat';

// Variabili globali per sessione
let sessionId = generateSessionId();

// Funzione per inviare messaggi (SICURA - nessuna API key esposta)
async function sendMessage(messageText) {
  const input = document.getElementById('chatInput');
  const messagesDiv = document.getElementById('chatMessages');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  
  // Usa il messaggio passato come parametro o quello nell'input
  const userMessage = messageText || input.value.trim();
  if (!userMessage) return;
  
  // Rimuovi welcome message se presente
  const welcome = messagesDiv.querySelector('.chat-welcome');
  if (welcome) welcome.remove();
  
  // Rimuovi suggerimenti precedenti
  removeSuggestions();
  
  // Aggiungi messaggio utente
  messagesDiv.innerHTML += `
    <div class="chat-message user">
      <div class="message-bubble">${escapeHtml(userMessage)}</div>
    </div>
  `;
  
  // Reset input e disabilita durante invio
  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;
  typingIndicator.classList.add('show');
  
  // Scroll to bottom
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  try {
    // Chiamata al backend Vercel con sessionId
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': sessionId
      },
      body: JSON.stringify({
        message: userMessage,
        sessionId: sessionId
      })
    });
    
    const data = await response.json();
    
    if (response.status === 429) {
      // Rate limiting
      showRateLimitMessage(data);
      return;
    }
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    // Aggiorna sessionId se fornito
    if (data.sessionId) {
      sessionId = data.sessionId;
    }
    
    const botReply = data.reply;
    
    // Aggiungi risposta bot
    const botMessageDiv = document.createElement('div');
    botMessageDiv.className = 'chat-message bot';
    botMessageDiv.innerHTML = `
      <div class="message-bubble">${escapeHtml(botReply).replace(/\n\n/g, '<br><br>').replace(/ðŸ“§|ðŸ“±/g, '<strong>$&</strong>')}</div>
    `;
    messagesDiv.appendChild(botMessageDiv);
    
    // Aggiungi suggerimenti se presenti
    if (data.suggestions && data.suggestions.length > 0) {
      showSuggestions(data.suggestions);
    }
    
    // Rendi cliccabili i link WhatsApp
    makeWhatsAppLinksClickable(messagesDiv);
    
  } catch (error) {
    // Messaggio di errore user-friendly
    messagesDiv.innerHTML += `
      <div class="chat-message bot">
        <div class="message-bubble">
          Mi dispiace, c'Ã¨ stato un problema di connessione. 
          <br><br><strong>ðŸ“§</strong> <a href="mailto:info@lucinedinatale.it" style="color: var(--christmas-red);">info@lucinedinatale.it</a>
          <br><strong>ðŸ“±</strong> <a href="https://wa.me/393123456789" target="_blank" style="color: var(--christmas-green);">WhatsApp</a>
        </div>
      </div>
    `;
    console.error('Chat Error:', error);
  } finally {
    // Riabilita input
    input.disabled = false;
    sendBtn.disabled = false;
    typingIndicator.classList.remove('show');
    input.focus();
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
}

function showRateLimitMessage(data) {
  const messagesDiv = document.getElementById('chatMessages');
  const escapeRoutes = data.escapeRoutes || [
    "Hai fatto troppe domande di seguito.",
    "ðŸ“§ info@lucinedinatale.it", 
    "ðŸ“± https://wa.me/393123456789"
  ];
  
  messagesDiv.innerHTML += `
    <div class="chat-message bot">
      <div class="message-bubble" style="border-color: orange;">
        ${escapeRoutes.map(route => escapeHtml(route)).join('<br><br>')}
      </div>
    </div>
  `;
  
  makeWhatsAppLinksClickable(messagesDiv);
}

function showSuggestions(suggestions) {
  const messagesDiv = document.getElementById('chatMessages');
  
  const suggestionsDiv = document.createElement('div');
  suggestionsDiv.className = 'chat-suggestions';
  suggestionsDiv.innerHTML = `
    <div class="suggestions-label">Domande correlate:</div>
    <div class="suggestions-buttons">
      ${suggestions.map(suggestion => `
        <button class="suggestion-btn" onclick="sendMessage('${escapeHtml(suggestion)}')">${escapeHtml(suggestion)}</button>
      `).join('')}
    </div>
  `;
  
  messagesDiv.appendChild(suggestionsDiv);
}

function removeSuggestions() {
  const suggestions = document.querySelector('.chat-suggestions');
  if (suggestions) {
    suggestions.remove();
  }
}

function makeWhatsAppLinksClickable(container) {
  const links = container.querySelectorAll('.message-bubble');
  links.forEach(bubble => {
    bubble.innerHTML = bubble.innerHTML.replace(
      /https:\/\/wa\.me\/\d+/g, 
      '<a href="$&" target="_blank" style="color: var(--christmas-green); text-decoration: underline;">$&</a>'
    );
  });
}

function generateSessionId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Funzione per escape HTML (sicurezza)
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Focus automatico all'input quando il snippet viene caricato
document.addEventListener('DOMContentLoaded', () => {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.focus();
  }
});

// Gestione mobile - previeni zoom su focus
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('chatInput');
  if (input && window.innerWidth <= 768) {
    input.addEventListener('focus', function() {
      if (this.getAttribute('readonly')) {
        this.removeAttribute('readonly');
        this.blur();
        this.focus();
      }
    });
    // Previeni zoom su mobile
    input.setAttribute('readonly', 'readonly');
    setTimeout(() => input.removeAttribute('readonly'), 100);
  }
});
</script>


  <!-- BIGLIETTI E PRENOTAZIONI -->
  <section id="biglietti" class="location-section">
    <h3 class="faq-section-header">Biglietti e Prenotazioni</h3>
    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ necessario prenotare la visita al Parco?</button>
        <div class="faq-answer">
          <p>Gli ingressi sono contingentati e su base oraria, suggeriamo quindi caldamente la prenotazione online cosÃ¬ da avere la certezza di trovare posto (e risparmiare!)</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile acquistare i biglietti online?</button>
        <div class="faq-answer">
          <p>Certo! Anzi Ã¨ assolutamente consigliato per essere certi di poter visitare le meravigliose installazioni senza problemi!</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">PerchÃ© prenotare online?</button>
        <div class="faq-answer">
          <p>Prenotando il biglietto online hai diritto a un <span class="faq-highlight">prezzo agevolato</span> e non dovrai fare la coda alla cassa in loco!</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Cosa Ã¨ incluso nel biglietto acquistato?</button>
        <div class="faq-answer">
          <p>Il biglietto di ingresso alle lucine prevede la visita dell'intero percorso all'interno del Parco. La casa illuminata e la zona dell'oratorio con mercatini e stand gastronomico sono invece ad accesso libero.</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile modificare le date dei biglietti?</button>
        <div class="faq-answer">
          <p>SÃ¬, Ã¨ possibile modificare la data per i biglietti che hai acquistato. Scrivi a <a href="mailto:info@lucinedinatale.it" style="color: var(--christmas-red);">info@lucinedinatale.it</a> con le informazioni utili per cambiare data/ora dei biglietti.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- BIGLIETTI SPECIALI -->
  <section id="saltafila" class="location-section">
    <h3 class="faq-section-header">Biglietti Speciali</h3>    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile saltare le code in biglietteria o all'ingresso?</button>
        <div class="faq-answer">
          <p>SÃ¬, solo ed esclusivamente acquistando online il biglietto <span class="faq-highlight">SALTAFILA</span> o <span class="faq-highlight">OPEN</span>.</p>
          <p><span class="faq-highlight-green">Il BIGLIETTO SALTAFILA comprende:</span></p>
          <p>â€¢ 1 ingresso alle Lucine di Natale<br>
          â€¢ Accesso prioritario nella fascia oraria scelta al momento dell'acquisto</p>
          <p><span class="faq-highlight-green">Il BIGLIETTO OPEN comprende:</span></p>
          <p>â€¢ 1 ingresso alle Lucine di Natale<br>
          â€¢ Ingresso con data e ora a scelta libera senza prenotazione<br>
          â€¢ Accesso prioritario sempre</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ho acquistato un biglietto SALTAFILA per me adulto e un biglietto ridotto. Possiamo usufruire entrambi dell'ingresso prioritario?</button>
        <div class="faq-answer">
          <p>No, solo i possessori dei biglietti SALTAFILA e OPEN possono usufruire dell'ingresso prioritario.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ACCESSIBILITÃ€, FAMIGLIE E SERVIZI -->
  <section id="accessibilita" class="location-section">
    <h3 class="faq-section-header">AccessibilitÃ , Famiglie e Servizi</h3>
    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">La visita Ã¨ possibile per le persone diversamente abili?</button>
        <div class="faq-answer">
          <p>La visita Ã¨ adatta a tutti i portatori di handicap. Il percorso ha capienza e larghezza sufficiente per carrozzine.</p>
          <p>Hanno diritto alla riduzione sul biglietto coloro in possesso di una documentazione di invaliditÃ /disabilitÃ  (da mostrare all'ingresso). La riduzione Ã¨ valida anche per 1 accompagnatore. L'accesso sarÃ  prioritario tramite ingresso dedicato.</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ prevista un'area di sosta dedicata ai portatori di handicap?</button>
        <div class="faq-answer">
          <p>SÃ¬, all'interno del P3 c'Ã¨ un'area dedicata. <a href="#info-parcheggi" style="color: var(--christmas-red);">Maggiori info sui parcheggi</a></p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile l'ingresso con passeggini e carrozzine?</button>
        <div class="faq-answer">
          <p>Certamente! Le Lucine di Natale sono un evento dedicato a tutta la famiglia, dai piÃ¹ piccoli alle persone con limitata mobilitÃ , grazie ad un'ampia passerella che vi guiderÃ  alla visita di ogni installazione luminosa presente nel parco.</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile portare animali domestici?</button>
        <div class="faq-answer">
          <p>Certo! I cani vanno tenuti al guinzaglio e, se di grossa taglia, devono indossare anche la museruola. SarÃ  vostra cura fare attenzione che il vostro miglior amico si comporti da vero "gentilcane" all'interno dell'area!</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Il vin brulÃ¨ puÃ² essere servito a minorenni?</button>
        <div class="faq-answer">
          <p>No, si ricorda che Ã¨ fatto divieto di vendita e di somministrazione di bevande alcoliche ai minori di anni 18.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- VISITA E ORARI -->
  <section id="visita" class="location-section">
    <h3 class="faq-section-header">Visita e Orari</h3>
    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Quanto dura la visita alle Lucine di Natale?</button>
        <div class="faq-answer">
          <p>Ãˆ possibile permanere all'interno del parco il tempo necessario per visitare le Lucine e completare il percorso. La fascia oraria indicata sul biglietto Ã¨ relativa alla fascia temporale in cui Ã¨ possibile accedere alle Lucine di Natale, non al tempo massimo in cui potete stare all'interno dell'area.</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Ãˆ possibile nell'arco di una stessa giornata entrare ed uscire dalle Lucine di Natale piÃ¹ volte?</button>
        <div class="faq-answer">
          <p>Il biglietto Ã¨ valido solo per un'entrata nell'orario indicato sul biglietto.</p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Quali sono gli orari delle Lucine di Natale?</button>
        <div class="faq-answer">
          <p>Tutte le informazioni su orari e giornate di chiusura le trovi nella sezione <a href="#info-parcheggi" style="color: var(--christmas-red);">Info &amp; Parcheggi</a></p>
        </div>
      </div>
    </div>
  </section>

  <!-- METEO -->
  <section id="meteo" class="location-section">
    <h3 class="faq-section-header">Condizioni Meteo</h3>
    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Cosa succede se piove il giorno in cui ho acquistato il biglietto?</button>
        <div class="faq-answer">
          <p>In caso di annullamento dell'evento nella data per cui hai scelto il biglietto ti verrÃ  fornito un codice per poter prenotare gratuitamente per una nuova data.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- COSA VISITARE -->
  <section id="dintorni" class="location-section">
    <h3 class="faq-section-header">Cosa Visitare</h3>
    
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Cosa posso visitare durante il giorno prima di venire alle Lucine?</button>
        <div class="faq-answer">
          <p>Ci sono diversi luoghi d'interesse a pochi km dalle Lucine che puoi visitare durante il giorno. Maggiori informazioni nella sezione <a href="#nei-dintorni" style="color: var(--christmas-red);">Nei Dintorni</a></p>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" onclick="toggleFAQ(this)">Dove posso andare a mangiare dopo aver visitato le Lucine di Natale?</button>
        <div class="faq-answer">
          <p>Ci sono diversi ristoranti partner delle Lucine di Natale: <a href="https://www.google.com/maps/d/viewer?mid=1_5wD0-jDWWYiXu_Ilw9aA3aFSyjBxxw&amp;ll=45.885422107847916%2C8.610271050000016&amp;z=13" style="color: var(--christmas-red);">Scopri i ristoranti partner</a></p>
        </div>
      </div>
    </div>
  </section>

  <!-- SERVIZIO CLIENTI -->
  <section class="location-section">
    <h3 class="faq-section-header">Servizio Clienti</h3>
    <p>Scrivi a <a href="mailto:info@lucinedinatale.it" style="color: var(--christmas-red);">info@lucinedinatale.it</a> per ottenere eventuali ulteriori informazioni non presenti nelle nostre FAQ.</p>
  </section>
</div>

<script>
function toggleFAQ(button) {
  const answer = button.nextElementSibling;
  const isActive = answer.classList.contains('active');
  
  // Close all answers
  document.querySelectorAll('.faq-answer').forEach(a => a.classList.remove('active'));
  document.querySelectorAll('.faq-question').forEach(q => q.classList.remove('active'));
  
  // Open clicked one if it wasn't already open
  if (!isActive) {
    answer.classList.add('active');
    button.classList.add('active');
  }
}
</script>