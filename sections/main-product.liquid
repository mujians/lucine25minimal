<!-- MAIN PRODUCT SECTION - Shopify Blocks Compatible -->
<div class="page-container" style="min-height: 100vh; padding: 2rem 1rem;">
  <div class="content-wrapper" style="max-width: 1200px; margin: 0 auto;">
    <div class="formatted-content" style="background: rgba(15, 47, 31, 0.4); border-radius: 16px; padding: 2rem; border: 1px solid rgba(255,255,255,0.1);">
      
      <!-- BREADCRUMB -->
      <nav class="breadcrumb">
        <a href="/">Home</a> / <a href="/collections/all">Biglietti</a> / <span>{{ product.title }}</span>
      </nav>

      <!-- MAIN PRODUCT SECTION -->
      <section class="product-main">
        
        <!-- PRODUCT IMAGES -->
        <div class="product-images">
          <div class="main-image">
            {% if product.featured_image %}
              <img src="{{ product.featured_image | img_url: '600x600' }}" alt="{{ product.title }}" class="product-image-main">
            {% else %}
              <img src="https://cdn.shopify.com/s/files/1/0605/2983/6205/files/IMG_2996.jpg?v=1699203223" alt="{{ product.title }}" class="product-image-main">
            {% endif %}
          </div>
          
          {% if product.images.size > 1 %}
          <div class="product-thumbnails">
            {% for image in product.images limit: 4 %}
              <img src="{{ image | img_url: '150x150' }}" alt="{{ product.title }}" class="product-thumbnail" onclick="changeMainImage(this)">
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- PRODUCT INFO -->
        <div class="product-info">
          
          <!-- RENDER BLOCKS OR DEFAULT CONTENT -->
          {% if section.blocks.size > 0 %}
            {% for block in section.blocks %}
              {% case block.type %}
              
              {% when 'title' %}
                <div class="product-header" {{ block.shopify_attributes }}>
                  <h1 style="color: var(--christmas-red); margin-bottom: 1rem; font-family: 'Homemade Apple', cursive;">{{ product.title }}</h1>
                  <p class="product-subtitle" style="font-size: 1.1rem; color: rgba(255,255,255,0.9); margin: 0;">{{ section.settings.subtitle | default: "Garantisciti l'accesso alle Lucine di Natale con prezzo agevolato e posto riservato" }}</p>
                </div>

              {% when 'custom_liquid' %}
                <div class="custom-liquid-block" {{ block.shopify_attributes }}>
                  {{ block.settings.custom_liquid }}
                </div>

              {% when 'price' %}
                {% unless block.settings.disabled %}
                <div class="sketch-card sketch seed-price" {{ block.shopify_attributes }}>
                  <svg class="sketch-border" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
                    <defs>
                      <filter id="wobble-price">
                        <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" seed="5"/>
                        <feDisplacementMap in="SourceGraphic" scale="1"/>
                      </filter>
                    </defs>
                    <rect x="4" y="4" width="92" height="92" rx="12" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-dasharray="14 8 6 12 10 9" vector-effect="non-scaling-stroke" filter="url(#wobble-price)"/>
                  </svg>
                  
                  <div class="product-price-section" style="text-align: center; padding: 1rem 0;">
                    <div class="price-display" style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                      {% if product.compare_at_price > product.price %}
                        <span class="price-compare" style="font-size: 1.2rem; color: rgba(255,255,255,0.6); text-decoration: line-through;">{{ product.compare_at_price | money }}</span>
                      {% endif %}
                      <span class="price-current" id="variant-price" style="font-size: 2rem; font-weight: 700; color: var(--christmas-red);">
                        {{ product.selected_or_first_available_variant.price | money }}
                      </span>
                    </div>
                    <p class="price-note" style="margin: 0; font-size: 0.9rem; color: var(--christmas-green); font-weight: 600;">{{ section.settings.price_note | default: "Prezzo agevolato online ‚Ä¢ Accesso garantito" }}</p>
                  </div>
                </div>
                {% endunless %}

              {% when 'variant_picker' %}
                {% unless product.has_only_default_variant %}
                <div class="product-variants" {{ block.shopify_attributes }}>
                  <h3 style="color: var(--christmas-green); margin-bottom: 1rem;">üé´ Scegli il tuo biglietto</h3>
                  
                  {% for option in product.options_with_values %}
                    <div class="variant-selector">
                      <label class="variant-selector__label" style="font-weight: 600; color: var(--christmas-green); font-size: 1.1rem; display: block; margin-bottom: 0.75rem;">{{ option.name }}</label>
                      {% assign option_index = forloop.index0 %}
                      <div class="variant-selector__options" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        {% for value in option.values %}
                          <input 
                            type="radio" 
                            id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            name="{{ option.name }}" 
                            value="{{ value | escape }}"
                            {% if option.selected_value == value %}checked{% endif %}
                            data-option-index="{{ option_index }}"
                            data-option-value="{{ value | escape }}"
                            onchange="updateVariant()"
                            style="display: none;"
                          >
                          <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}" class="variant-label" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <span class="variant-type" style="font-weight: 600; color: white;">
                              {% if value contains 'Ridotto' %}üéüÔ∏è{% elsif value contains 'Saltafila' %}‚ö°{% else %}üé´{% endif %}
                              {{ value }}
                            </span>
                            {% for variant in product.variants %}
                              {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                                <span class="variant-price" style="font-weight: 700; color: var(--christmas-red); font-size: 1.1rem;">{{ variant.price | money }}</span>
                                {% break %}
                              {% endif %}
                            {% endfor %}
                          </label>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                {% endunless %}

              {% when 'quantity_selector' %}
                <div class="product-quantity" {{ block.shopify_attributes }}>
                  <label for="Quantity-{{ section.id }}" style="color: var(--christmas-green); font-weight: 600; display: block; margin-bottom: 0.5rem;">Quantit√†</label>
                  <div class="quantity-controls" style="display: flex; align-items: center; background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; width: fit-content;">
                    <button type="button" name="minus" class="quantity__button" onclick="changeQuantity(-1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚àí</button>
                    <input 
                      class="quantity__input"
                      type="number" 
                      name="quantity" 
                      id="Quantity-{{ section.id }}"
                      min="1" 
                      value="1"
                      style="background: transparent; border: none; color: white; text-align: center; width: 60px; height: 40px; font-size: 1.1rem;"
                    >
                    <button type="button" name="plus" class="quantity__button" onclick="changeQuantity(1)" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">+</button>
                  </div>
                </div>

              {% when 'buy_buttons' %}
                {% unless block.settings.disabled %}
                {% form 'product', product, id: 'product-form', class: 'product-form' %}
                  <div class="product-form__buttons" {{ block.shopify_attributes }}>
                    <button
                      type="submit" 
                      name="add"
                      class="btn product-form__cart-submit"
                      style="display: flex; justify-content: space-between; align-items: center; background: var(--christmas-red); color: white; border: none; padding: 1.2rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); text-decoration: none; width: 100%;"
                      {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
                    >
                      <span>
                        {% if product.selected_or_first_available_variant.available %}
                          üéüÔ∏è Aggiungi al Carrello
                        {% else %}
                          Non Disponibile
                        {% endif %}
                      </span>
                      <span class="btn-price" id="total-price" style="font-size: 1.2rem; font-weight: 700;">{{ product.selected_or_first_available_variant.price | money }}</span>
                    </button>
                    
                    {% if block.settings.show_dynamic_checkout %}
                      {{ form | payment_button }}
                    {% endif %}
                  </div>

                  <!-- VARIANT DATA -->
                  <script type="application/json" id="product-variants">
                    {{ product.variants | json }}
                  </script>
                  
                {% endform %}
                {% endunless %}

              {% when 'share' %}
                {% unless block.settings.disabled %}
                <div class="product-share" {{ block.shopify_attributes }}>
                  <!-- Share buttons implementation -->
                </div>
                {% endunless %}

              {% when 'collapsible_tab' %}
                <details class="collapsible-tab" {{ block.shopify_attributes }}>
                  <summary style="color: var(--christmas-green); font-weight: 600; padding: 1rem 0; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    {% if block.settings.icon %}{{ block.settings.icon }}{% endif %} {{ block.settings.heading }}
                  </summary>
                  <div style="padding: 1rem 0;">
                    {% if block.settings.content != blank %}
                      {{ block.settings.content }}
                    {% elsif block.settings.page != blank %}
                      {% assign page = pages[block.settings.page] %}
                      {{ page.content }}
                    {% endif %}
                  </div>
                </details>

            {% endcase %}
          {% endfor %}

        </div>
      </section>

    </div>
  </div>
</div>

{% schema %}
{
  "name": "Main Product",
  "tag": "section",
  "class": "section-main-product",
  "blocks": [
    {
      "type": "title",
      "name": "Product Title",
      "limit": 1
    },
    {
      "type": "custom_liquid",
      "name": "Custom Liquid",
      "settings": [
        {
          "type": "liquid",
          "id": "custom_liquid",
          "label": "Custom Liquid",
          "info": "Add custom Liquid code or HTML"
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Variant Picker",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker Type",
          "options": [
            {"value": "dropdown", "label": "Dropdown"},
            {"value": "button", "label": "Button"}
          ],
          "default": "button"
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity Selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy Buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "Show Dynamic Checkout Buttons",
          "default": true,
          "info": "Shows express payment options like PayPal, Apple Pay, etc."
        }
      ]
    },
    {
      "type": "share",
      "name": "Share",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "share_label",
          "label": "Share Label",
          "default": "Share"
        }
      ]
    },
    {
      "type": "collapsible_tab",
      "name": "Collapsible Tab",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {"value": "", "label": "None"},
            {"value": "check_mark", "label": "Check Mark"}
          ],
          "default": ""
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Tab Content"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Tab Content from Page"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Product Subtitle",
      "default": "Garantisciti l'accesso alle Lucine di Natale con prezzo agevolato e posto riservato"
    },
    {
      "type": "text",
      "id": "price_note",
      "label": "Price Note",
      "default": "Prezzo agevolato online ‚Ä¢ Accesso garantito"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_info",
      "label": "Enable Sticky Product Info",
      "default": true
    },
    {
      "type": "select",
      "id": "media_size",
      "label": "Media Size",
      "options": [
        {"value": "small", "label": "Small"},
        {"value": "medium", "label": "Medium"},
        {"value": "large", "label": "Large"}
      ],
      "default": "small"
    },
    {
      "type": "select",
      "id": "media_position",
      "label": "Media Position",
      "options": [
        {"value": "left", "label": "Left"},
        {"value": "right", "label": "Right"}
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "hide_variants",
      "label": "Hide Variants",
      "default": true
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom Padding", 
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 44
    }
  ]
}
{% endschema %}

<style>
/* Product Page Styles */
.breadcrumb {
  margin: 1rem 0 2rem 0;
  font-size: 0.9rem;
  color: rgba(255,255,255,0.8);
}

.breadcrumb a {
  color: var(--christmas-green);
  text-decoration: underline;
}

.breadcrumb span {
  color: white;
}

.product-main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 3rem;
  margin: 3rem 0;
}

/* Product Images */
.product-images {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.product-image-main {
  width: 100%;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.product-thumbnails {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
}

.product-thumbnail {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  cursor: pointer;
  opacity: 0.7;
  transition: all 0.3s ease;
}

.product-thumbnail:hover {
  opacity: 1;
  transform: scale(1.05);
}

/* Product Info */
.product-info {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

/* Variant Labels */
.variant-selector__options input[type="radio"]:checked + .variant-label {
  background: rgba(139, 195, 74, 0.1) !important;
  border-color: var(--christmas-green) !important;
  box-shadow: 0 0 0 1px var(--christmas-green);
}

.variant-label:hover {
  background: rgba(255,255,255,0.08) !important;
  border-color: var(--christmas-green) !important;
}

/* Buttons */
.btn:hover {
  background: #b91c1c !important;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4) !important;
}

.btn:disabled {
  background: #666 !important;
  color: #999 !important;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.quantity__button:hover {
  background: rgba(255,255,255,0.2) !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .product-main {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  
  .price-display {
    flex-direction: column !important;
    gap: 0.5rem !important;
  }
  
  .product-form__buttons {
    position: sticky;
    bottom: 1rem;
    background: rgba(15, 47, 31, 0.95);
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .quantity-controls {
    justify-content: center;
    margin: 1rem auto !important;
  }
}
</style>

<script>
// Variant Management
function updateVariant() {
  const selectedOptions = {};
  
  // Get selected options
  document.querySelectorAll('.variant-selector input[type="radio"]:checked').forEach(input => {
    const optionIndex = input.dataset.optionIndex;
    selectedOptions[`option${parseInt(optionIndex) + 1}`] = input.value;
  });
  
  // Find matching variant
  const variants = JSON.parse(document.getElementById('product-variants').textContent);
  const selectedVariant = variants.find(variant => {
    return Object.keys(selectedOptions).every(key => 
      variant[key] === selectedOptions[key]
    );
  });
  
  if (selectedVariant) {
    // Update price
    const priceFormatted = new Intl.NumberFormat('it-IT', {
      style: 'currency',
      currency: 'EUR'
    }).format(selectedVariant.price / 100);
    
    const priceElement = document.getElementById('variant-price');
    if (priceElement) priceElement.textContent = priceFormatted;
    updateTotalPrice();
    
    // Update form variant id
    const form = document.getElementById('product-form');
    if (form) {
      let variantInput = form.querySelector('input[name="id"]');
      if (!variantInput) {
        variantInput = document.createElement('input');
        variantInput.type = 'hidden';
        variantInput.name = 'id';
        form.appendChild(variantInput);
      }
      variantInput.value = selectedVariant.id;
      
      // Update button availability
      const addButton = form.querySelector('button[type="submit"]');
      if (addButton) {
        if (selectedVariant.available) {
          addButton.disabled = false;
          addButton.querySelector('span').textContent = 'üéüÔ∏è Aggiungi al Carrello';
        } else {
          addButton.disabled = true;
          addButton.querySelector('span').textContent = 'Non Disponibile';
        }
      }
    }
  }
}

function changeQuantity(change) {
  const quantityInput = document.querySelector('.quantity__input');
  if (quantityInput) {
    let currentQty = parseInt(quantityInput.value) || 1;
    let newQty = currentQty + change;
    
    if (newQty >= 1 && newQty <= 10) {
      quantityInput.value = newQty;
      updateTotalPrice();
    }
  }
}

function updateTotalPrice() {
  const priceElement = document.getElementById('variant-price');
  const totalPriceElement = document.getElementById('total-price');
  const quantityInput = document.querySelector('.quantity__input');
  
  if (priceElement && totalPriceElement && quantityInput) {
    const priceText = priceElement.textContent;
    const price = parseFloat(priceText.replace('‚Ç¨', '').replace(',', '.').replace('\u00A0', '').trim());
    const quantity = parseInt(quantityInput.value) || 1;
    const total = price * quantity;
    
    const totalFormatted = new Intl.NumberFormat('it-IT', {
      style: 'currency',
      currency: 'EUR'
    }).format(total);
    
    totalPriceElement.textContent = totalFormatted;
  }
}

function changeMainImage(thumbnail) {
  const mainImage = document.querySelector('.product-image-main');
  if (mainImage) {
    mainImage.src = thumbnail.src.replace('150x150', '600x600');
    
    // Update active thumbnail
    document.querySelectorAll('.product-thumbnail').forEach(thumb => {
      thumb.style.opacity = '0.7';
    });
    thumbnail.style.opacity = '1';
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateVariant();
  updateTotalPrice();
  
  // Handle quantity input changes
  const quantityInput = document.querySelector('.quantity__input');
  if (quantityInput) {
    quantityInput.addEventListener('input', updateTotalPrice);
  }
});
</script>